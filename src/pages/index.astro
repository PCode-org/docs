---
/**
 * Hagicode 首页
 * 集成所有首页组件,展示产品特性和功能
 */
import Navbar from '../components/home/Navbar';
import HeroSection from '../components/home/HeroSection';
import ActivityMetricsSection from '../components/home/ActivityMetricsSection';
import FeaturesShowcase from '../components/home/FeaturesShowcase';
import ShowcaseSection from '../components/home/ShowcaseSection';
import VideoShowcase from '../components/home/VideoShowcase';
import Footer from '../components/home/Footer';
import LunarNewYearDecorations from '../components/home/LunarNewYearDecorations';
import { LunarNewYearCardGroup } from '../components/home/LunarNewYearCard';
import Clarity from '../components/Clarity.astro';
// 导入首页样式
import '../styles/homepage.css';

// 导入版本数据工具函数
import { fetchDesktopVersions, groupAssetsByPlatform } from "@/utils/desktop";
import type { DesktopVersion, PlatformGroup } from "@/types/desktop";

// 页面元数据
const title = 'Hagicode - 智能 · 便捷 · 有趣的 AI 编码助手';
const description = '用 AI 重新定义代码开发体验。OpenSpec 工作流、多线程会话管理、成就系统,让编码更高效、更有趣';

// 获取站点基础路径
const siteBase = import.meta.env.VITE_SITE_BASE || '/';

// 在构建时获取版本数据（用于 InstallButton）
let desktopVersionData: {
  latest: DesktopVersion | null;
  platforms: PlatformGroup[];
  error: string | null;
} = {
  latest: null,
  platforms: [],
  error: null,
};

try {
  const data = await fetchDesktopVersions();
  desktopVersionData.latest = data.versions[0] || null;
  if (desktopVersionData.latest) {
    desktopVersionData.platforms = groupAssetsByPlatform(desktopVersionData.latest.assets);
  }
} catch (e) {
  desktopVersionData.error = e instanceof Error ? e.message : String(e);
  console.error("Failed to fetch desktop versions for homepage:", e);
}
---

<!doctype html>
<html lang="zh-CN" data-site-base={siteBase}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <!-- 百度搜索引擎验证 -->
    <meta name="baidu-site-verification" content="codeva-A9s3yT3z5m" />
    <meta name="og:title" content={title} />
    <meta name="og:description" content={description} />
    <meta name="og:type" content="website" />
    <script is:inline>
      // 初始化主题 - 在页面加载前执行，避免闪烁
      // 与 Starlight 文档站同步使用 starlight-theme 键
      (function() {
        // 判断是否在农历新年期间
        // 蛇年2025: 2025-01-29 至 2025-02-12 (元宵节)
        // 马年2026: 2026-02-17 至 2026-03-03 (元宵节)
        function isLunarNewYearPeriod() {
          const now = new Date();
          const year = now.getFullYear();
          const month = now.getMonth() + 1; // 1-12
          const day = now.getDate();

          // 2025年蛇年新年期间 (1月29日 - 2月12日)
          if (year === 2025) {
            if (month === 1 && day >= 29) return true;
            if (month === 2 && day <= 12) return true;
          }
          // 2026年马年新年期间 (2月17日 - 3月3日)
          if (year === 2026) {
            if (month === 2 && day >= 17) return true;
            if (month === 3 && day <= 3) return true;
          }
          return false;
        }

        const stored = localStorage.getItem('starlight-theme');
        const system = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        let theme;

        if (stored) {
          // 用户已有主题偏好,使用其选择
          theme = stored;
        } else {
          // 用户无主题偏好,应用智能默认
          theme = isLunarNewYearPeriod() ? 'lunar-new-year' : system;
        }

        document.documentElement.setAttribute('data-theme', theme);
      })();
    </script>
  </head>
  <body class="homepage">
    <!-- 新年主题装饰 - 仅在农历新年主题下显示 -->
    <LunarNewYearDecorations client:load />

    <Navbar
      client:load
      desktopVersion={desktopVersionData.latest}
      desktopPlatforms={desktopVersionData.platforms}
      desktopVersionError={desktopVersionData.error}
    />

    <main class="homepage">
      <!-- Hero Section - 首屏必需 -->
      <HeroSection
        desktopVersion={desktopVersionData.latest}
        desktopPlatforms={desktopVersionData.platforms}
        desktopVersionError={desktopVersionData.error}
        client:load
      />

      <!-- 新年主题卡片组 - 仅在农历新年主题下显示 -->
      <LunarNewYearCardGroup client:load />

      <!-- Activity Metrics Section -->
      <ActivityMetricsSection client:load />

      <!-- Features Showcase -->
      <FeaturesShowcase client:load />

      <!-- Showcase Section -->
      <ShowcaseSection client:load />

      <!-- Video Showcase -->
      <VideoShowcase
        videoId="BV1pirZBuEzq"
        title="每天哈基半小时,AI多任务编程实战"
        description="通过视频快速了解 Hagicode 的核心功能和使用方法"
        client:load
      />
    </main>

    <!-- Footer -->
    <Footer client:load />

    <!-- Microsoft Clarity 分析 -->
    <Clarity />
  </body>
</html>
