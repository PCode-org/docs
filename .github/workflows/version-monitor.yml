name: Version Monitor

# Trigger the workflow every 30 minutes and allow manual triggering
on:
  push:
    branches:
      - main
  schedule:
    - cron: "*/30 * * * *" # Run every 30 minutes
  workflow_dispatch: # Allow manual trigger from GitHub Actions UI

# Set permissions for creating branches, commits, and pull requests
permissions:
  contents: write
  pull-requests: write

jobs:
  monitor:
    name: Monitor Version Changes
    runs-on: ubuntu-latest
    outputs:
      pr_created: ${{ steps.monitor.outputs.pr_created }}
      new_version: ${{ steps.monitor.outputs.new_version }}
      pr_url: ${{ steps.monitor.outputs.pr_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Display configuration
        run: |
          echo "Version Monitor Configuration"
          echo "=========================="
          echo "Source URL: ${{ vars.VERSION_SOURCE_URL || 'https://desktop.dl.hagicode.com/index.json' }}"
          echo "Request Timeout: 30000ms"
          echo "Max Retries: 3"
          echo "Repository: ${{ github.repository }}"

      - name: Run version monitor
        id: monitor
        run: node scripts/version-monitor.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          VERSION_SOURCE_URL: ${{ vars.VERSION_SOURCE_URL || 'https://desktop.dl.hagicode.com/index.json' }}
          REQUEST_TIMEOUT: "30000"
          MAX_RETRIES: "3"

      - name: Display result
        if: always()
        run: |
          echo "Version Monitor Result"
          echo "======================"
          if [ -f ".github/version-state.json" ]; then
            echo "Last Checked Version: $(jq -r '.lastCheckedVersion // "N/A"' .github/version-state.json)"
            echo "Last Checked Time: $(jq -r '.lastCheckedTime // "N/A"' .github/version-state.json)"
            echo "Last Deployed Version: $(jq -r '.lastDeployedVersion // "N/A"' .github/version-state.json)"
            echo "Check Count: $(jq -r '.checkCount // 0' .github/version-state.json)"
          fi

      - name: Pull Request created notification
        if: steps.monitor.outputs.pr_created == 'true'
        run: |
          echo "Pull Request Created"
          echo "===================="
          echo "PR Number: ${{ steps.monitor.outputs.pr_number }}"
          echo "PR URL: ${{ steps.monitor.outputs.pr_url }}"

  notify-version-update:
    needs: monitor
    if: needs.monitor.outputs.pr_created == 'true'
    uses: HagiCode-org/haginotifier/.github/workflows/notify.yml@main
    with:
      msg_type: 'post'
      title: 'Version Monitor'
      message: |
        ## Version Monitor

        **Áä∂ÊÄÅ**: üîÑ ÂèëÁé∞Êñ∞ÁâàÊú¨
        **Êñ∞ÁâàÊú¨**: ${{ needs.monitor.outputs.new_version }}
        **‰ªìÂ∫ì**: ${{ github.repository }}
        **PR ÈìæÊé•**: ${{ needs.monitor.outputs.pr_url }}
        **ËøêË°åËØ¶ÊÉÖ**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    secrets:
      FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}

  notify-failure:
    needs: monitor
    if: failure()
    uses: HagiCode-org/haginotifier/.github/workflows/notify.yml@main
    with:
      msg_type: 'post'
      title: 'Version Monitor'
      message: |
        ## Version Monitor

        **Áä∂ÊÄÅ**: ‚ùå Â§±Ë¥•
        **‰ªìÂ∫ì**: ${{ github.repository }}
        **Ëß¶ÂèëËÄÖ**: ${{ github.actor }}
        **ËøêË°åËØ¶ÊÉÖ**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    secrets:
      FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
