name: Update Activity Metrics

on:
  # 定时触发 - 每天 UTC 00:00 运行
  schedule:
    - cron: '0 0 * * *'

  # 手动触发用于测试
  workflow_dispatch:

  # 允许从其他工作流触发
  workflow_call:

permissions:
  contents: write
  pull-requests: write

env:
  NODE_VERSION: '20'
  DOCKER_HUB_REPOSITORY: 'newbe36524/hagicode'

jobs:
  update-metrics:
    name: Fetch and Update Activity Metrics
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          npm ci

      - name: Run metrics update script
        env:
          CLARITY_API_KEY: ${{ secrets.CLARITY_API_KEY }}
          HAGICODE_CLARITY_PROJECT_ID: ${{ secrets.HAGICODE_CLARITY_PROJECT_ID }}
          DOCKER_HUB_REPOSITORY: ${{ env.DOCKER_HUB_REPOSITORY }}
        run: |
          npm run update-metrics

      - name: Calculate metrics diff
        id: diff
        run: |
          # 读取新数据
          NEW_DATA=$(cat apps/website/public/activity-metrics.json)

          # 尝试读取旧数据（从 main 分支）
          if git show main:apps/website/public/activity-metrics.json &>/dev/null; then
            OLD_DATA=$(git show main:apps/website/public/activity-metrics.json)

            # 提取各指标的新旧值
            OLD_PULL=$(echo "$OLD_DATA" | jq -r '.dockerHub.pullCount // 0')
            NEW_PULL=$(echo "$NEW_DATA" | jq -r '.dockerHub.pullCount // 0')

            OLD_USERS=$(echo "$OLD_DATA" | jq -r '.clarity.activeUsers // 0')
            NEW_USERS=$(echo "$NEW_DATA" | jq -r '.clarity.activeUsers // 0')

            OLD_SESSIONS=$(echo "$OLD_DATA" | jq -r '.clarity.activeSessions // 0')
            NEW_SESSIONS=$(echo "$NEW_DATA" | jq -r '.clarity.activeSessions // 0')

            # 计算差值和百分比
            # Docker Hub 拉取次数
            DELTA_PULL=$((NEW_PULL - OLD_PULL))
            if [ "$OLD_PULL" -gt 0 ]; then
              PERCENT_PULL=$(awk "BEGIN {printf \"%.1f\", ($DELTA_PULL / $OLD_PULL) * 100}")
            else
              PERCENT_PULL="N/A"
            fi

            # 活跃用户
            DELTA_USERS=$((NEW_USERS - OLD_USERS))
            if [ "$OLD_USERS" -gt 0 ]; then
              PERCENT_USERS=$(awk "BEGIN {printf \"%.1f\", ($DELTA_USERS / $OLD_USERS) * 100}")
            else
              PERCENT_USERS="N/A"
            fi

            # 活跃会话
            DELTA_SESSIONS=$((NEW_SESSIONS - OLD_SESSIONS))
            if [ "$OLD_SESSIONS" -gt 0 ]; then
              PERCENT_SESSIONS=$(awk "BEGIN {printf \"%.1f\", ($DELTA_SESSIONS / $OLD_SESSIONS) * 100}")
            else
              PERCENT_SESSIONS="N/A"
            fi

            # 生成对比表格
            DIFF_TABLE="| 指标 | 原值 | 新值 | 变化 |
            |------|------|------|------|"

            # Docker Hub 拉取次数
            if [ "$DELTA_PULL" -gt 0 ]; then
              DIFF_TABLE="$DIFF_TABLE
            | Docker Hub 拉取次数 | $OLD_PULL | $NEW_PULL | ↑${DELTA_PULL} (▲${PERCENT_PULL}%) |"
            elif [ "$DELTA_PULL" -lt 0 ]; then
              DIFF_TABLE="$DIFF_TABLE
            | Docker Hub 拉取次数 | $OLD_PULL | $NEW_PULL | ↓${DELTA_PULL#-} (▼${PERCENT_PULL}%) |"
            else
              DIFF_TABLE="$DIFF_TABLE
            | Docker Hub 拉取次数 | $OLD_PULL | $NEW_PULL | →0 (▶0%) |"
            fi

            # 活跃用户
            if [ "$DELTA_USERS" -gt 0 ]; then
              DIFF_TABLE="$DIFF_TABLE
            | 活跃用户 (近3天) | $OLD_USERS | $NEW_USERS | ↑${DELTA_USERS} (▲${PERCENT_USERS}%) |"
            elif [ "$DELTA_USERS" -lt 0 ]; then
              DIFF_TABLE="$DIFF_TABLE
            | 活跃用户 (近3天) | $OLD_USERS | $NEW_USERS | ↓${DELTA_USERS#-} (▼${PERCENT_USERS}%) |"
            else
              DIFF_TABLE="$DIFF_TABLE
            | 活跃用户 (近3天) | $OLD_USERS | $NEW_USERS | →0 (▶0%) |"
            fi

            # 活跃会话
            if [ "$DELTA_SESSIONS" -gt 0 ]; then
              DIFF_TABLE="$DIFF_TABLE
            | 活跃会话 (近3天) | $OLD_SESSIONS | $NEW_SESSIONS | ↑${DELTA_SESSIONS} (▲${PERCENT_SESSIONS}%) |"
            elif [ "$DELTA_SESSIONS" -lt 0 ]; then
              DIFF_TABLE="$DIFF_TABLE
            | 活跃会话 (近3天) | $OLD_SESSIONS | $NEW_SESSIONS | ↓${DELTA_SESSIONS#-} (▼${PERCENT_SESSIONS}%) |"
            else
              DIFF_TABLE="$DIFF_TABLE
            | 活跃会话 (近3天) | $OLD_SESSIONS | $NEW_SESSIONS | →0 (▶0%) |"
            fi

            # 计算变化统计
            CHANGED_COUNT=0
            GROWTH_COUNT=0
            DECLINE_COUNT=0

            [ "$DELTA_PULL" -ne 0 ] && CHANGED_COUNT=$((CHANGED_COUNT + 1))
            [ "$DELTA_USERS" -ne 0 ] && CHANGED_COUNT=$((CHANGED_COUNT + 1))
            [ "$DELTA_SESSIONS" -ne 0 ] && CHANGED_COUNT=$((CHANGED_COUNT + 1))

            [ "$DELTA_PULL" -gt 0 ] && GROWTH_COUNT=$((GROWTH_COUNT + 1))
            [ "$DELTA_USERS" -gt 0 ] && GROWTH_COUNT=$((GROWTH_COUNT + 1))
            [ "$DELTA_SESSIONS" -gt 0 ] && GROWTH_COUNT=$((GROWTH_COUNT + 1))

            [ "$DELTA_PULL" -lt 0 ] && DECLINE_COUNT=$((DECLINE_COUNT + 1))
            [ "$DELTA_USERS" -lt 0 ] && DECLINE_COUNT=$((DECLINE_COUNT + 1))
            [ "$DELTA_SESSIONS" -lt 0 ] && DECLINE_COUNT=$((DECLINE_COUNT + 1))

            # 生成摘要
            if [ "$GROWTH_COUNT" -gt 0 ] && [ "$DECLINE_COUNT" -eq 0 ]; then
              SUMMARY="**摘要**: $CHANGED_COUNT 个指标发生变化，全部呈现增长趋势 📈"
            elif [ "$DECLINE_COUNT" -gt 0 ] && [ "$GROWTH_COUNT" -eq 0 ]; then
              SUMMARY="**摘要**: $CHANGED_COUNT 个指标发生变化，全部呈现下降趋势 📉"
            elif [ "$GROWTH_COUNT" -gt 0 ] && [ "$DECLINE_COUNT" -gt 0 ]; then
              SUMMARY="**摘要**: $CHANGED_COUNT 个指标发生变化，$GROWTH_COUNT 个增长，$DECLINE_COUNT 个下降 📊"
            else
              SUMMARY="**摘要**: 所有指标保持不变 ➡️"
            fi

            # 输出到环境变量
            {
              echo "diff_table<<EOF"
              echo "$DIFF_TABLE"
              echo "EOF"
              echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
              echo "has_diff=true" >> $GITHUB_OUTPUT
            } >> $GITHUB_OUTPUT
          else
            # 首次运行，无旧数据
            {
              echo "diff_table> ℹ️ 首次运行，无历史数据进行对比。"
              echo "summary=" >> $GITHUB_OUTPUT
              echo "has_diff=false" >> $GITHUB_OUTPUT
            } >> $GITHUB_OUTPUT
          fi

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create feature branch
        run: |
          # 使用固定分支名称,避免创建多个临时分支
          BRANCH_NAME="metrics-update"
          git checkout -b "$BRANCH_NAME"
          echo "Created branch: $BRANCH_NAME"

      - name: Commit changes
        run: |
          git add apps/website/public/activity-metrics.json
          git commit -m "chore: update activity metrics data

          - 更新时间: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"

      - name: Delete remote branch if exists
        run: |
          # 检查远程分支是否存在,如果存在则删除
          if git ls-remote --heads origin metrics-update | grep -q "metrics-update"; then
            echo "Deleting existing remote branch metrics-update"
            git push origin --delete metrics-update
          else
            echo "Remote branch metrics-update does not exist"
          fi

      - name: Push branch
        run: |
          # 使用 --force-with-lease 安全地强制推送,完全替换远程分支内容
          git push origin metrics-update --force-with-lease

      - name: Close previous activity metrics PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 查找并关闭之前的同类 PR
          PREVIOUS_PRS=$(gh pr list \
            --search "chore: update activity metrics data in:head" \
            --state open \
            --json number \
            --jq '.[].number')

          if [ -n "$PREVIOUS_PRS" ]; then
            echo "$PREVIOUS_PRS" | while read -r pr_number; do
              echo "Closing previous PR #$pr_number"
              gh pr close "$pr_number" \
                --comment "由于新的指标更新 PR 自动关闭"
            done
          else
            echo "No previous activity metrics PRs found"
          fi

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 读取最新的指标数据用于 PR 描述
          PULL_COUNT=$(jq -r '.dockerHub.pullCount' apps/website/public/activity-metrics.json)
          ACTIVE_USERS=$(jq -r '.clarity.activeUsers' apps/website/public/activity-metrics.json)
          ACTIVE_SESSIONS=$(jq -r '.clarity.activeSessions' apps/website/public/activity-metrics.json)
          LAST_UPDATED=$(jq -r '.lastUpdated' apps/website/public/activity-metrics.json)

          # 获取对比结果
          DIFF_TABLE="${{ steps.diff.outputs.diff_table }}"
          SUMMARY="${{ steps.diff.outputs.summary }}"

          # 构建 PR 描述
          PR_BODY="## 活动指标更新

          ### 摘要
          此 PR 更新首页的活动指标数据。

          ### 指标变化对比

          $DIFF_TABLE
          $SUMMARY

          ### 详细数据
          | 指标 | 数值 |
          |------|------|
          | Docker Hub 拉取次数 | $PULL_COUNT |
          | 活跃用户 (近3天) | $ACTIVE_USERS |
          | 活跃会话 (近3天) | $ACTIVE_SESSIONS |
          | 更新时间 | $LAST_UPDATED |

          ### 变更
          - 更新 \`public/activity-metrics.json\` 为最新指标

          ### 自动化
          此 PR 由 [Update Activity Metrics](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) 工作流自动创建。"

          gh pr create \
            --title "chore: update activity metrics data" \
            --body "$PR_BODY" \
            --base main \
            --head "metrics-update" \
            --label "automation,metrics"

      - name: Summary
        run: |
          PULL_COUNT=$(jq -r '.dockerHub.pullCount' apps/website/public/activity-metrics.json)
          ACTIVE_USERS=$(jq -r '.clarity.activeUsers' apps/website/public/activity-metrics.json)
          ACTIVE_SESSIONS=$(jq -r '.clarity.activeSessions' apps/website/public/activity-metrics.json)
          LAST_UPDATED=$(jq -r '.lastUpdated' apps/website/public/activity-metrics.json)

          echo "### 活动指标更新 :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| 指标 | 数值 |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Hub 拉取次数 | $PULL_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| 活跃用户 (近3天) | $ACTIVE_USERS |" >> $GITHUB_STEP_SUMMARY
          echo "| 活跃会话 (近3天) | $ACTIVE_SESSIONS |" >> $GITHUB_STEP_SUMMARY
          echo "| 更新时间 | $LAST_UPDATED |" >> $GITHUB_STEP_SUMMARY
