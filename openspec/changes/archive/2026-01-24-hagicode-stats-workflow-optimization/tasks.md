# Implementation Tasks

## 1. 修改工作流分支管理逻辑

- [x] 1.1 将分支命名从动态时间戳改为固定名称
  - 修改 `.github/workflows/update-activity-metrics.yml` 第 188 行
  - 从 `BRANCH_NAME="update-activity-metrics-$(date +%s)"` 改为 `BRANCH_NAME="metrics-update"`
  - 确保分支名称具有明确的语义和唯一性

- [x] 1.2 添加远程分支删除步骤
  - 在 "Push branch" 步骤之前添加新的步骤 "Delete remote branch if exists"
  - 使用 `git ls-remote --heads origin metrics-update` 检查远程分支是否存在
  - 如果存在,使用 `git push origin --delete metrics-update` 删除远程分支
  - 添加适当的日志输出以便调试

- [x] 1.3 修改推送方式为强制推送
  - 将 "Push branch" 步骤中的推送命令改为强制推送
  - 从 `git push origin "${{ steps.create-branch.outputs.branch_name }}"` 改为 `git push origin metrics-update --force-with-lease`
  - 考虑使用 `--force-with-lease` 作为更安全的选项
  - 添加错误处理逻辑,确保推送失败时工作流能够正确报告错误

- [x] 1.4 优化分支创建步骤
  - 简化 "Create feature branch" 步骤的输出
  - 由于使用固定分支名称,可以移除动态输出的 branch_name 变量
  - 确保后续步骤正确引用固定的分支名称

## 2. 验证和测试

- [ ] 2.1 本地测试工作流
  - 使用 `act` 工具在本地模拟工作流运行(如果可用)
  - 或创建测试分支手动验证工作流配置的正确性
  - 确保所有步骤能够正确执行

- [ ] 2.2 手动触发工作流测试
  - 在 GitHub 仓库中手动触发 "Update Activity Metrics" 工作流
  - 验证工作流成功完成并创建 PR
  - 确认远程只存在一个 `metrics-update` 分支

- [ ] 2.3 验证 PR 创建和关闭逻辑
  - 确认新的 PR 正确创建
  - 确认旧的 PR 被正确关闭
  - 验证 PR 包含正确的指标数据和变化对比表格

- [ ] 2.4 验证数据完整性
  - 检查 PR 中的 `data/activity-metrics.json` 文件内容正确
  - 确认指标变化对比表格准确反映数据变化
  - 验证摘要信息正确生成

- [ ] 2.5 验证分支清理
  - 确认旧的临时分支(如果存在)被正确删除
  - 验证远程仓库分支列表只包含一个 `metrics-update` 分支
  - 确认没有遗留的 `update-activity-metrics-*` 分支

## 3. 文档和监控

- [ ] 3.1 更新工作流注释
  - 在关键步骤添加注释说明固定分支和强制推送的用途
  - 记录删除远程分支的原因和目的
  - 确保工作流文件的可读性和可维护性

- [ ] 3.2 添加工作流输出信息
  - 在 "Summary" 步骤中添加分支管理相关信息
  - 输出使用的分支名称和推送方式
  - 便于后续调试和监控

- [ ] 3.3 验证定时任务正常运行
  - 等待下一个定时触发时间(UTC 00:00)
  - 确认工作流自动运行并成功创建 PR
  - 验证持续运行稳定性

## 4. 清理旧分支(可选)

- [ ] 4.1 识别并清理旧的临时分支
  - 列出所有 `update-activity-metrics-*` 分支
  - 确认这些分支对应的 PR 已关闭或合并
  - 批量删除这些废弃的分支

- [ ] 4.2 验证清理结果
  - 确认远程仓库分支列表干净
  - 确认只保留必要的分支(main, gh-pages, metrics-update)
  - 更新仓库维护文档(如果需要)

## 5. 实施后检查清单

- [ ] 5.1 确认工作流运行成功
  - 检查最近几次工作流运行的状态
  - 确保所有步骤都成功完成
  - 无错误或警告

- [ ] 5.2 确认 PR 质量良好
  - PR 标题和描述格式正确
  - 包含完整的指标变化对比
  - 正确标记标签(automation, metrics)

- [ ] 5.3 确认仓库状态健康
  - 分支列表简洁明了
  - 无积累的临时分支
  - PR 列表只包含一个活动的统计更新 PR

- [ ] 5.4 确认数据一致性
  - 首页显示的指标数据与 PR 中的数据一致
  - 数据更新及时且准确
  - 无数据丢失或重复

## 依赖关系

- 任务 1 必须在任务 2 之前完成(先修改,后测试)
- 任务 2 可以在任务 1 完成后立即开始
- 任务 3 可以与任务 2 并行进行
- 任务 4 是可选的,可以在任务 1-3 完成后的任何时间进行
- 任务 5 必须在所有其他任务完成后进行

## 预估工作量

- 任务 1: 约 30 分钟(修改工作流配置)
- 任务 2: 约 1 小时(测试和验证)
- 任务 3: 约 30 分钟(文档和监控)
- 任务 4: 约 30 分钟(可选)
- 任务 5: 约 30 分钟(最终检查)

**总计**: 约 2.5-3 小时(不包括可选的任务 4)
