# 实施任务清单

本文档列出了创建全局统一安装按钮组件的详细实施步骤。任务按逻辑顺序排列，每个任务都应该是可独立验证的。

## 前置准备

- [ ] **任务 0.1**: 阅读 `proposal.md` 理解变更目标和范围
- [ ] **任务 0.2**: 阅读现有的 Desktop 下载实现
  - 查看 `src/pages/desktop/index.astro` 了解数据获取逻辑
  - 查看 `src/components/desktop/DownloadOption.astro` 了解下载按钮实现
  - 查看 `src/utils/desktop.ts` 了解版本数据处理
  - 查看 `src/types/desktop.ts` 了解类型定义
- [ ] **任务 0.3**: 分析现有的 Header/Navbar 实现
  - 查看 `src/components/home/Navbar.tsx` 了解当前「立即安装」按钮的实现
  - 确认当前按钮的跳转逻辑（跳转到 `/desktop` 页面）
  - 分析 Navbar 的布局和样式约束

## 数据和类型准备

- [ ] **任务 1.1**: 确认共享类型定义
  - 复查 `src/types/desktop.ts` 是否包含所有必需类型
  - 确认 `DesktopVersion`、`PlatformDownload`、`AssetType` 等类型可用
  - 如需要，添加首页专用的接口定义

- [ ] **任务 1.2**: 添加平台检测工具函数
  - 在 `src/utils/desktop.ts` 中添加 `detectOS()` 函数
  - 实现基于 UserAgent 的操作系统检测
  - 支持查询字符串覆盖 (`?os=windows|macos|linux`)
  - 添加单元测试验证检测逻辑

## 组件开发

- [ ] **任务 2.1**: 创建安装按钮组件框架
  - 创建 `src/components/home/InstallButton.astro`
  - 定义组件 Props 接口:
    - `latestVersion`: `DesktopVersion | null` - 最新版本数据
    - `showDropdown`: `boolean` - 是否显示下拉菜单（默认 true）
    - `variant`: `'full' | 'compact'` - 显示模式（完整模式用于 Hero，紧凑模式用于 Header）
  - 添加基础 HTML 结构和 Astro frontmatter

- [ ] **任务 2.2**: 实现主下载按钮
  - 创建分体式按钮布局（主下载区域 + 下拉切换按钮）
  - 主按钮显示固定文案「立即安装」
  - 根据检测结果设置下载链接
  - 添加下载图标和箭头图标
  - 根据 variant 属性调整按钮尺寸和样式

- [ ] **任务 2.3**: 实现下拉菜单
  - 为同一平台的多个版本创建下拉菜单
  - 显示版本标签和文件大小
  - **在菜单最后一项添加「安装 Docker 版本」选项**
  - **为 Docker 选项添加分隔线和不同的视觉样式**
  - 实现展开/折叠交互
  - 添加键盘导航支持（方向键、Enter、Esc）
  - 确保下拉菜单在不同 variant 下的位置适配

- [ ] **任务 2.4**: 实现客户端交互脚本
  - 添加下拉菜单切换逻辑
  - 实现点击外部关闭菜单
  - 实现菜单项选择时更新主按钮链接
  - **实现「安装 Docker 版本」点击后导航到 `/installation/docker-compose`**
  - 添加 ARIA 属性支持无障碍访问

- [ ] **任务 2.5**: 创建组件样式
  - 创建 `src/components/home/InstallButton.module.css`（或使用 scoped styles）
  - 复用 `homepage.css` 中的按钮样式变量
  - 实现分体式按钮布局样式
  - 实现 full 和 compact 两种模式的样式变体
  - **为「安装 Docker 版本」菜单项添加特殊样式（分隔线、不同图标）**
  - 添加悬停和激活状态效果
  - 确保支持亮色/暗色/农历新年主题

## 首页集成

- [ ] **任务 3.1**: 修改 HeroSection 组件
  - 打开 `src/components/home/HeroSection.tsx`
  - 在组件顶部导入新的 `InstallButton` 组件
  - 替换现有的「开始使用」按钮为 `InstallButton`（使用 `variant="full"`）
  - 保持「了解更多」按钮不变

- [ ] **任务 3.2**: 获取版本数据
  - 在 HeroSection 组件中添加 `useEffect` 或在服务端获取数据
  - 复用 `fetchDesktopVersions()` 函数获取最新版本
  - 处理数据获取失败的情况（显示降级版本）

- [ ] **任务 3.3**: 调整 Hero 区域布局
  - 确保 `InstallButton` 与其他按钮布局协调
  - 调整按钮间距和对齐方式
  - 验证响应式布局在移动端和桌面端的表现

## Header 集成

- [ ] **任务 3.4**: 修改 Navbar 组件
  - 打开 `src/components/home/Navbar.tsx`
  - 在组件顶部导入新的 `InstallButton` 组件
  - 找到现有的「立即安装」按钮（当前跳转到 `/desktop`）
  - 替换为 `InstallButton`（使用 `variant="compact"`）
  - 移除原有的页面跳转逻辑

- [ ] **任务 3.5**: 共享版本数据
  - 考虑创建全局状态管理或 Context 来共享版本数据
  - 或者让 Navbar 和 HeroSection 各自获取数据
  - 确保数据获取失败时的降级处理一致

- [ ] **任务 3.6**: 调整 Header 布局
  - 确保 compact 模式的按钮适合 Header 空间
  - 在移动端菜单中验证按钮显示效果
  - 确保下拉菜单不会遮挡其他导航元素

## 样式适配

- [ ] **任务 4.1**: 适配亮色主题
  - 测试按钮在亮色主题下的显示效果
  - 确保文字对比度符合 WCAG AA 标准
  - 验证渐变和发光效果

- [ ] **任务 4.2**: 适配暗色主题
  - 测试按钮在暗色主题下的显示效果
  - 确保文字和边框清晰可见
  - 验证主题切换时无闪烁

- [ ] **任务 4.3**: 适配农历新年主题
  - 测试按钮在农历新年主题下的显示效果
  - 确保红金配色正确应用
  - 验证与其他新年主题元素的一致性

- [ ] **任务 4.4**: 响应式设计验证
  - 测试移动端布局（< 768px）
  - 测试平板端布局（768px - 1024px）
  - 测试桌面端布局（> 1024px）
  - 确保按钮在各尺寸下都可正常点击
  - 特别验证 Header 中的 compact 模式在移动端的表现

## 交互验证

- [ ] **任务 5.1**: 测试下载功能
  - 测试 Hero 区域主按钮点击能正确跳转
  - 测试 Header 中主按钮点击能正确跳转
  - 测试下拉菜单中的版本选项（两个位置）
  - **测试「安装 Docker 版本」选项点击后正确跳转到 `/installation/docker-compose`**
  - 验证所有下载链接格式正确
  - 确认两个位置的按钮功能一致

- [ ] **任务 5.2**: 测试平台检测
  - 在不同操作系统下测试自动检测
  - 测试查询字符串覆盖功能
  - 验证 UserAgent 检测的准确性

- [ ] **任务 5.3**: 测试键盘导航
  - 测试 Tab 键焦点顺序
  - 测试方向键在菜单中的导航
  - 测试 Enter 和 Esc 键功能

- [ ] **任务 5.4**: 测试触摸交互
  - 在移动设备上测试触摸交互
  - 测试下拉菜单的展开/折叠
  - 验证触摸区域足够大（至少 44x44px）

## 错误处理

- [ ] **任务 6.1**: 处理数据获取失败
  - 当 `fetchDesktopVersions()` 失败时显示降级版本
  - 降级版本显示链接到 Desktop 下载页面
  - 提供清晰的错误提示

- [ ] **任务 6.2**: 处理无版本数据
  - 当 `latestVersion` 为 null 时显示占位内容
  - 或显示跳转到 Desktop 页面的链接

- [ ] **任务 6.3**: 处理平台检测失败
  - 当无法检测操作系统时显示所有平台选项
  - 提供手动选择平台的界面

## 性能优化

- [ ] **任务 7.1**: 优化组件渲染
  - 确保组件使用 Astro 静态生成
  - 避免不必要的客户端 JavaScript
  - 使用 `client:visible` 或 `client:idle` 按需加载

- [ ] **任务 7.2**: 优化样式加载
  - 使用 CSS Modules 或 scoped styles 避免样式冲突
  - 确保样式按需加载
  - 避免重复的 CSS 规则

## 验证测试

- [ ] **任务 8.1**: TypeScript 类型检查
  ```bash
  npm run typecheck
  ```
  - 确保无 TypeScript 错误
  - 验证所有 Props 接口正确

- [ ] **任务 8.2**: 本地构建验证
  ```bash
  npm run build
  ```
  - 确保构建成功无错误
  - 检查构建输出

- [ ] **任务 8.3**: 开发服务器预览
  ```bash
  npm run dev
  ```
  - 在浏览器中访问首页
  - 访问其他页面测试 Header 中的按钮
  - 测试所有交互功能
  - 测试不同主题下的显示效果

- [ ] **任务 8.4**: 跨浏览器测试
  - Chrome/Edge (Chromium)
  - Firefox
  - Safari (如可用)
  - 移动端浏览器 (iOS Safari, Android Chrome)

- [ ] **任务 8.5**: 无障碍访问测试
  - 使用屏幕阅读器测试
  - 验证 ARIA 标签正确
  - 测试键盘导航完整性

## 文档完善

- [ ] **任务 9.1**: 添加组件注释
  - 为 `InstallButton.astro` 添加详细的组件说明
  - 注释关键逻辑和设计决策
  - 说明与 Desktop DownloadOption 的差异

- [ ] **任务 9.2**: 更新相关文档
  - 如需要，更新首页相关文档
  - 记录查询字符串参数的使用方法

## 发布准备

- [ ] **任务 10.1**: 最终审查
  - 完整测试所有功能（Hero 和 Header 两处）
  - 确认符合 `proposal.md` 中的所有目标
  - 检查与现有首页风格的一致性
  - 验证两个位置的按钮功能完全一致
  - 确认 Header 按钮不再跳转到 Desktop 页面

- [ ] **任务 10.2**: 提交前检查
  - 运行 `npm run typecheck` 确保无类型错误
  - 运行 `npm run build` 确保构建成功
  - 检查文件命名符合规范
  - 确认文件位于正确路径

## 任务依赖关系

```
前置准备 (任务 0.1-0.3)
    ↓
数据和类型准备 (任务 1.1-1.2)
    ↓
组件开发 (任务 2.1-2.5) → 顺序执行
    ↓
首页集成 (任务 3.1-3.3) → 顺序执行
    ↓
Header 集成 (任务 3.4-3.6) → 顺序执行
    ↓
样式适配 (任务 4.1-4.4) → 并行执行
    ↓
交互验证 (任务 5.1-5.4) → 并行执行
    ↓
错误处理 (任务 6.1-6.3) → 并行执行
    ↓
性能优化 (任务 7.1-7.2) → 并行执行
    ↓
验证测试 (任务 8.1-8.5) → 顺序执行
    ↓
文档完善 (任务 9.1-9.2) → 并行执行
    ↓
发布准备 (任务 10.1-10.2)
```

## 总计任务数

- **必需任务**: 47 个（任务 0.1-10.2，新增了 Header 集成相关任务）
- **预计完成时间**: 5-7 小时

## 注意事项

1. **遵循 OpenSpec 工作流**: 在提案获得批准前不要开始实施
2. **复用现有实现**: 充分复用 Desktop 下载页面的逻辑和样式
3. **保持简洁**: 按钮应保持简洁，避免过度复杂
4. **性能优先**: 确保组件不影响页面加载性能
5. **无障碍访问**: 确保组件支持键盘导航和屏幕阅读器
6. **主题一致性**: 在所有主题下测试样式一致性
7. **降级处理**: 优先实现健壮的错误处理和降级方案
8. **功能一致性**: Header 和 Hero 两处的按钮必须功能完全一致，都是直接下载而非跳转页面
