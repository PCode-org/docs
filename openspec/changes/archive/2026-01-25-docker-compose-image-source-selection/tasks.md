# Tasks: Docker Compose 镜像源选择功能

## 概述

本文档列出了为 Docker Compose 生成器添加镜像源选择功能的实现任务。任务按照交付增量价值和早期验证的原则排序。

## 任务列表

### 阶段 1：类型定义和配置

#### 1. 添加镜像源类型定义

在 Docker Compose 生成器中添加镜像源相关的类型定义和常量。

**实现步骤：**
1. 在 `docker-compose-generator.tsx` 中添加 `ImageRegistry` 类型：
   ```typescript
   type ImageRegistry = 'docker-hub' | 'azure-acr';
   ```
2. 创建镜像源配置接口 `RegistryConfig`
3. 定义 `REGISTRIES` 常量对象，包含所有镜像源的配置信息
4. 在 `DockerComposeConfig` 接口中添加 `imageRegistry` 字段

**验证标准：**
- [x] TypeScript 类型检查通过（`npm run typecheck`）
- [x] `REGISTRIES` 对象包含所有必需字段（id, name, description, imagePrefix, recommended, networkAdvice）
- [x] Docker Hub 配置的 `imagePrefix` 为 `newbe36524/hagicode`
- [x] ACR 配置的 `imagePrefix` 为 `hagicode.azurecr.io/hagicode`

**依赖：** 无

**预估复杂度：** 低

---

#### 2. 更新默认配置

在 `defaultConfig` 对象中添加镜像源字段的默认值。

**实现步骤：**
1. 在 `defaultConfig` 中添加 `imageRegistry: 'docker-hub'`
2. 确保默认值为 `docker-hub` 以保持向后兼容

**验证标准：**
- [x] 默认配置包含 `imageRegistry` 字段
- [x] 默认值为 `'docker-hub'`
- [x] 生成器页面加载时默认选择 Docker Hub

**依赖：** 任务 1

**预估复杂度：** 低

---

### 阶段 2：YAML 生成逻辑

#### 3. 修改 YAML 生成函数

更新 `generateYAML()` 函数，根据选择的镜像源动态生成镜像地址。

**实现步骤：**
1. 在 `generateYAML()` 函数中，找到生成镜像地址的行（约第 118 行）
2. 将固定的镜像地址 `newbe36524/hagicode:${config.imageTag}` 替换为动态生成的地址
3. 使用 `REGISTRIES[config.imageRegistry].imagePrefix` 获取镜像前缀
4. 保留镜像标签 `${config.imageTag}` 的使用

**验证标准：**
- [x] 当 `imageRegistry` 为 `'docker-hub'` 时，生成的镜像地址为 `newbe36524/hagicode:{tag}`
- [x] 当 `imageRegistry` 为 `'azure-acr'` 时，生成的镜像地址为 `hagicode.azurecr.io/hagicode:{tag}`
- [x] 镜像标签正确附加在镜像地址后
- [x] 生成的 YAML 格式保持一致，无额外空格或换行

**依赖：** 任务 1

**预估复杂度：** 低

---

### 阶段 3：用户界面实现

#### 4. 添加镜像源选择器组件

在生成器表单中添加镜像源选择的 UI 组件。

**实现步骤：**
1. 在表单中找到合适的位置（建议放在"容器镜像"部分之后或"基础设置"部分）
2. 添加镜像源选择器的 JSX 结构：
   - 使用 `<select>` 元素或自定义下拉组件
   - 为每个镜像源选项添加清晰标签和说明
   - 添加推荐标记（Docker Hub 显示"推荐"）
3. 添加镜像源说明文本：
   - Docker Hub："Docker 官方镜像源，推荐使用"
   - ACR："备选镜像源，与 Docker Hub 保持同步"
4. 添加网络环境建议：
   - Docker Hub："适合支持 Docker Hub 镜像加速的用户"
   - ACR："适合本地网络无法访问 Docker Hub 的用户"

**验证标准：**
- [x] 镜像源选择器在表单中可见
- [x] 两个镜像源选项都清晰可辨
- [x] Docker Hub 选项显示"推荐"标记
- [x] 每个选项都有说明文字和网络环境建议
- [x] 选择器默认选中 Docker Hub

**依赖：** 任务 1, 2

**预估复杂度：** 中

---

#### 5. 连接状态管理

将镜像源选择器与组件状态连接。

**实现步骤：**
1. 在现有 `useState` 调用中添加 `imageRegistry` 状态
2. 为镜像源选择器添加 `onChange` 事件处理
3. 更新状态时触发 YAML 重新生成
4. 确保状态变化实时反映在预览区域

**验证标准：**
- [x] 选择器值变化时，`config.imageRegistry` 状态正确更新
- [x] 状态变化触发 YAML 预览更新
- [x] 切换镜像源后，预览中的镜像地址立即更新
- [x] 状态与其他配置项互不干扰

**依赖：** 任务 4

**预估复杂度：** 低

---

#### 6. 样式调整（如需要）

根据需要调整样式以保持界面一致性。

**实现步骤：**
1. 检查现有样式是否适用于新组件
2. 如需要，在 `docker-compose-generator.module.css` 中添加样式类
3. 确保样式与现有表单元素一致
4. 测试响应式布局

**验证标准：**
- [x] 镜像源选择器样式与其他表单元素一致
- [x] 说明文本清晰可读
- [x] 移动端布局正常
- [x] 无 CSS 控制台错误

**依赖：** 任务 4

**预估复杂度：** 低

---

### 阶段 4：持久化和用户体验

#### 7. 添加用户偏好持久化

使用 LocalStorage 保存用户的镜像源选择。

**实现步骤：**
1. 在组件挂载时从 LocalStorage 读取 `imageRegistry` 值
2. 如果存在保存的值，使用该值初始化状态
3. 在镜像源选择变化时，保存到 LocalStorage
4. 处理 LocalStorage 不可用的情况（降级处理）

**验证标准：**
- [x] 用户选择的镜像源在页面刷新后保持不变
- [x] 首次访问时使用默认值（Docker Hub）
- [x] LocalStorage 错误时不影响生成器功能
- [x] 清除浏览器数据后恢复默认值

**依赖：** 任务 5

**预估复杂度：** 中

---

#### 8. 添加镜像源切换提示

为用户提供关于镜像源选择的额外提示信息。

**实现步骤：**
1. 在镜像源选择器附近添加信息提示框
2. 说明何时应该选择哪个镜像源
3. 提供 Docker Hub 镜像加速配置链接（如有）
4. 说明 ACR 镜像与 Docker Hub 的同步关系

**验证标准：**
- [x] 提示信息清晰易懂
- [x] 用户能够根据提示做出正确选择
- [x] 提示信息不干扰主要操作
- [x] 提示内容在文档中有对应详细说明

**依赖：** 任务 4

**预估复杂度：** 低

---

### 阶段 5：文档更新

#### 9. 更新 Docker Compose 部署文档

在 `docs/installation/docker-compose.md` 中添加镜像源选择的说明。

**实现步骤：**
1. 在文档中找到"快速开始"或"生成配置文件"部分
2. 添加镜像源选择的说明：
   - 解释两个镜像源的区别
   - 说明推荐的使用场景
   - 提供镜像源选择的最佳实践
3. 添加 ACR 镜像的说明（与 Docker Hub 同步）
4. 更新配置生成器的使用说明，包含镜像源选择步骤
5. 添加注意事项：
   - ACR 镜像同步说明
   - 网络环境选择建议
   - 镜像版本一致性说明

**验证标准：**
- [x] 文档清晰说明镜像源选择功能
- [x] 包含两个镜像源的适用场景
- [x] 提供 ACR 镜像的同步说明
- [x] 文档格式符合项目规范
- [x] 文档构建无错误或警告

**依赖：** 任务 1-8

**预估复杂度：** 中

---

### 阶段 6：测试和验证

#### 10. 功能测试

全面测试镜像源选择功能。

**实现步骤：**
1. 启动开发服务器（`npm start`）
2. 测试默认配置（Docker Hub）
3. 测试切换到 ACR 镜像源
4. 验证生成的 YAML 文件中的镜像地址正确
5. 测试所有配置组合（镜像源 + 数据库类型 + API 提供商等）
6. 测试 LocalStorage 持久化
7. 测试边界情况（空配置、重置等）

**验证标准：**
- [x] 所有功能按预期工作
- [x] 无控制台错误或警告
- [x] 生成的 YAML 文件格式正确
- [x] 两个镜像源的镜像地址都正确生成
- [x] LocalStorage 持久化正常工作
- [x] 边界情况处理正确

**依赖：** 所有前置任务

**预估复杂度：** 中

---

#### 11. 类型检查和构建验证

确保代码符合 TypeScript 和构建要求。

**实现步骤：**
1. 运行 TypeScript 类型检查：`npm run typecheck`
2. 修复所有类型错误（如有）
3. 运行生产构建：`npm run build`
4. 检查构建输出，确保无错误
5. 测试生产构建版本

**验证标准：**
- [x] `npm run typecheck` 无错误
- [x] `npm run build` 成功完成
- [x] 生产构建版本功能正常
- [x] 无控制台警告或错误

**依赖：** 任务 10

**预估复杂度：** 低

---

#### 12. 文档构建验证

验证文档更新后的构建和渲染。

**实现步骤：**
1. 运行文档构建：`npm run build`
2. 检查更新后的文档页面
3. 验证文档中的链接和格式
4. 确认文档在导航中可见

**验证标准：**
- [x] 文档构建成功
- [x] 更新的内容正确渲染
- [x] 文档内链接工作正常
- [x] Markdown 格式正确

**依赖：** 任务 9

**预估复杂度：** 低

---

## 任务汇总

| 阶段 | 任务 | 总复杂度 |
|------|------|---------|
| 类型定义和配置 | 2 | 低 |
| YAML 生成逻辑 | 1 | 低 |
| 用户界面实现 | 3 | 低-中 |
| 持久化和用户体验 | 2 | 低-中 |
| 文档更新 | 1 | 中 |
| 测试和验证 | 3 | 低-中 |
| **总计** | **12** | **低-中** |

## 并行化机会

以下任务可以在依赖满足后并行执行：

- **任务 4, 5, 6**（UI 实现）有部分并行化机会：
  - 任务 4 的 UI 结构和任务 5 的状态管理可以交替进行
  - 任务 6（样式调整）可以在任务 4 完成后独立进行

- **任务 7, 8**（持久化和提示）可以并行开发（独立功能）

- **任务 9**（文档更新）可以在任务 1-8 完成后开始，与测试并行

- **任务 10, 11, 12**（测试验证）部分可以并行：
  - 任务 11 和 12 可以在任务 10 的同时进行

## 关键路径

交付功能的关键路径为：

1. 任务 1 → 任务 3 → 任务 4 → 任务 5 → 任务 10

这条路径必须完成才能提供可工作的镜像源选择功能。

## 完成定义

一个任务被认为完成时：
1. 所有实现步骤已执行
2. 所有验证标准已满足
3. 无控制台错误或警告（除非明确可接受）
4. 代码符合项目规范
5. 变更可以向相关方演示

整个变更完成时：
1. 所有 12 个任务完成
2. 开发服务器运行无错误
3. 生产构建成功
4. 文档清晰准确
5. 至少一个其他人员能够使用新功能

## 额外验证

在完成所有任务后，进行以下额外验证：

- [ ] 在真实环境中测试两个镜像源的拉取（如有条件）
- [ ] 验证 ACR 镜像标签与 Docker Hub 一致
- [ ] 收集用户反馈（如有测试用户）
- [ ] 确认文档对新用户友好易懂
- [ ] 验证功能在不同网络环境下的表现
