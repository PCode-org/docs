# 实施任务清单

本文档列出了创建 Hagicode Desktop 产品展示和下载页面的详细实施步骤。任务按逻辑顺序排列,每个任务都应该是可独立验证的。

## 数据源限制说明

**重要**: `desktop.dl.hagicode.com/index.json` 的实际结构有以下限制:

1. **不包含平台分类**: 文件按名称排列,需要从文件名推断平台类型
2. **不包含更新日志 (changelog)**: 无法从该 API 获取版本更新内容
3. **不包含发布日期**: 仅包含 `updatedAt` (整个索引的更新时间)

**应对方案**:
- 实现平台推断逻辑 (`inferAssetType` 函数)
- 版本历史中的更新日志需要在页面中手动维护或从其他来源获取 (如 GitHub Releases)
- 显示版本号但不显示具体发布日期,或使用"最新版本"等通用描述

**实际数据结构**:
```json
{
  "updatedAt": 1770464994.265596,
  "versions": [
    {
      "version": "v0.1.1",
      "files": ["Hagicode.Desktop.Setup.0.1.1.exe", ...],
      "assets": [
        {
          "name": "Hagicode.Desktop.Setup.0.1.1.exe",
          "path": "v0.1.1/Hagicode.Desktop.Setup.0.1.1.exe",
          "size": 104175915,
          "lastModified": null
        },
        ...
      ]
    }
  ]
}
```

## 前置准备

- [ ] **任务 0.1**: 阅读 `proposal.md` 理解变更目标和范围
- [ ] **任务 0.2**: 阅读 `openspec/project.md` 了解项目约定和技术栈
- [ ] **任务 0.3**: 已移至任务 0.3a (见数据结构设计部分)
- [ ] **任务 0.4**: 查看现有导航配置 `src/config/navigation.ts` 了解集成方式

## 数据结构设计

- [ ] **任务 0.3a**: **[重要]** 检查 `desktop.dl.hagicode.com/index.json` 的实际数据结构
  - 使用 `curl https://desktop.dl.hagicode.com/index.json` 获取原始数据
  - 确认实际的 JSON 结构 (包含 `updatedAt`, `versions`, `files`, `assets`)
  - **注意**: 该数据结构不包含平台分类、更新日志或发布日期
  - 记录文件名命名模式以用于平台推断

- [ ] **任务 1.1**: 定义版本数据接口
  - 创建 `src/types/desktop.ts` 定义 TypeScript 接口
  - **基于实际的 `index.json` 结构**定义类型:
    - `DesktopIndexResponse`: 包含 `updatedAt` 和 `versions[]`
    - `DesktopVersion`: 包含 `version`, `files[]`, `assets[]`
    - `DesktopAsset`: 包含 `name`, `path`, `size`, `lastModified`
  - 定义应用层使用的 `PlatformDownload` 接口
  - 定义 `AssetType` 枚举 (windows-setup, macos-intel, linux-appimage 等)
  - 确保类型安全且可扩展

- [ ] **任务 1.2**: 实现平台推断工具函数
  - 在 `src/utils/desktop.ts` 中创建 `inferAssetType(filename: string)` 函数
  - 基于文件名模式匹配推断平台和类型:
    - `.exe` 结尾 → Windows (便携版)
    - `Setup.*.exe` → Windows (安装程序,推荐)
    - `.appx` → Windows Store
    - `*-arm64.dmg` → macOS Apple Silicon
    - `.dmg` → macOS Intel/通用
    - `.AppImage` → Linux AppImage
    - `*_amd64.deb` → Linux Debian
    - `.tar.gz` → 源代码/压缩包
  - 返回 `AssetType` 或 `null` (无法识别)
  - 添加单元测试验证推断逻辑

- [ ] **任务 1.3**: 实现数据获取和转换工具函数
  - 在 `src/utils/desktop.ts` 中实现 `fetchDesktopVersions()` 函数
  - 从 `https://desktop.dl.hagicode.com/index.json` 获取版本数据
  - 实现超时处理 (30 秒超时)
  - 将原始数据转换为应用层格式:
    - 遍历所有 `assets`
    - 使用 `inferAssetType()` 分类每个文件
    - 按平台分组下载链接
    - 格式化文件大小 (字节 → MB/GB)
  - 构建完整的下载链接 (`https://desktop.dl.hagicode.com/{path}`)
  - 实现错误处理和数据验证
  - 返回类型安全的版本数据

## 页面结构

- [ ] **任务 2.1**: 创建页面目录结构
  ```bash
  mkdir -p src/pages/desktop
  mkdir -p src/components/desktop
  ```

- [ ] **任务 2.2**: 创建主页面框架
  - 创建 `src/pages/desktop/index.astro`
  - 添加基础 HTML 结构和 Astro frontmatter
  - 设置页面标题和描述
  - 导入必要的组件和工具函数
  - 在构建时获取版本数据

## 组件开发

- [ ] **任务 3.1**: 创建下载按钮组件
  - 创建 `src/components/desktop/DownloadButton.astro`
  - Props 接口:
    - `assetType`: `AssetType` (枚举)
    - `asset`: `DesktopAsset` (文件资源信息)
    - `label`: `string` (按钮文本)
    - `recommended`: `boolean` (是否为推荐选项)
  - 实现按钮样式 (与站点设计系统一致)
  - 添加平台图标 (使用 Starlight 图标系统)
  - 显示格式化的文件大小
  - 支持外部链接 (rel="noopener noreferrer")
  - 推荐选项显示"推荐"标签

- [ ] **任务 3.2**: 创建版本资源列表组件
  - 创建 `src/components/desktop/VersionDownloads.astro`
  - Props 接口: `version` (版本对象,包含处理后的平台分组数据)
  - 按平台分组显示下载选项:
    - Windows: Setup 安装程序 (推荐)、便携版、Microsoft Store
    - macOS: Apple Silicon (推荐)、Intel 版
    - Linux: AppImage (推荐)、Debian 包、源代码
  - 使用 DownloadButton 组件渲染每个下载选项
  - 支持展开/折叠不同平台的下载选项
  - 显示版本号和文件大小

- [ ] **任务 3.3**: 创建功能特性卡片组件
  - 创建 `src/components/desktop/FeatureCard.astro`
  - Props 接口: `icon`, `title`, `description`
  - 实现卡片布局和样式
  - 支持悬停效果
  - 响应式网格布局

- [ ] **任务 3.4**: 创建版本历史卡片组件
  - 创建 `src/components/desktop/VersionCard.astro`
  - Props 接口: `version` (版本对象)
  - 显示版本号、发布日期、更新日志
  - 支持展开/折叠更新日志
  - 时间倒序排列

## 页面内容实现

- [ ] **任务 4.1**: 实现 Hero Section
  - 添加产品标题和描述
  - 使用 VersionDownloads 组件显示最新版本的下载选项
  - 显示最新版本信息 (版本号)
  - **注意**: 由于 `index.json` 不包含发布日期,不显示日期或显示"最新版本"文本
  - 添加产品截图或预览图 (可选)

- [ ] **任务 4.2**: 实现功能特性区域
  - 使用 FeatureCard 组件展示核心功能
  - 至少包含 3-6 个核心特性
  - 使用响应式网格布局
  - 图标使用 Starlight 图标系统

- [ ] **任务 4.3**: 实现系统要求区域
  - 列出各平台的系统要求
  - 使用 Tabs 组件分离不同平台
  - 包含操作系统版本、硬件要求等
  - 添加注意事项和兼容性说明

- [ ] **任务 4.4**: 实现安装指南区域
  - 使用 Tabs 组件分离不同平台
  - 提供详细的安装步骤
  - 添加常见安装问题和解决方案
  - 包含安装验证步骤

- [ ] **任务 4.5**: 实现版本历史区域
  - 显示从 `index.json` 获取的所有版本列表
  - **注意**: `index.json` 不包含更新日志,需要决定显示方式:
    - 选项 A: 仅显示版本号和可用平台
    - 选项 B: 手动维护版本历史内容 (推荐)
  - 使用可折叠的版本列表
  - 时间倒序排列 (最新在前)
  - 每个版本显示版本号和可用下载链接

- [ ] **任务 4.6**: 实现 FAQ 区域
  - 使用 Starlight Details 组件
  - 包含 5-10 个常见问题
  - 每个问题有清晰的答案
  - 包含相关文档的链接

## 导航集成

- [ ] **任务 5.1**: 更新导航配置
  - 修改 `src/config/navigation.ts`
  - 添加 "桌面客户端" 导航链接
  - 设置正确的图标 (如 "laptop")
  - 使用 `withBasePath` 工具函数

- [ ] **任务 5.2**: 验证导航链接
  - 确保链接在所有页面正确显示
  - 测试链接可点击且导航正确
  - 确认响应式布局 (移动端菜单)

## 样式适配

- [ ] **任务 6.1**: 适配站点主题
  - 使用站点 CSS 变量 (`--sl-color-*`)
  - 支持浅色和深色主题
  - 确保文字对比度符合 WCAG AA 标准
  - 测试主题切换时的样式

- [ ] **任务 6.2**: 响应式设计验证
  - 测试移动端布局 (< 768px)
  - 测试平板端布局 (768px - 1024px)
  - 测试桌面端布局 (> 1024px)
  - 确保所有组件在各尺寸正常显示

## 错误处理

- [ ] **任务 7.1**: 实现数据获取失败处理
  - 当 `index.json` 获取失败时显示友好错误信息
  - 提供直接链接到 `desktop.dl.hagicode.com` 作为备选方案
  - 确保页面在无数据情况下仍可访问
  - 错误信息应清晰说明问题并提供解决方案

- [ ] **任务 7.2**: 实现超时处理
  - 设置 30 秒超时限制
  - 超时后显示超时提示
  - 提供手动下载链接作为备选方案 (直接链接到 desktop.dl.hagicode.com)

- [ ] **任务 7.3**: 实现数据验证
  - 验证 `index.json` 数据结构
  - 检查必需字段是否存在 (`updatedAt`, `versions`)
  - 检查 `versions` 数组是否为空
  - 验证 `assets` 数组的完整性
  - 处理缺失或无效的数据
  - 记录数据验证错误到控制台
  - **新增**: 验证平台推断结果,确保至少有一个平台可下载

## 性能优化

- [ ] **任务 8.1**: 优化数据获取
  - 考虑实现数据缓存机制
  - 减少不必要的数据重获取
  - 优化网络请求

- [ ] **任务 8.2**: 优化页面加载
  - 使用 Astro 静态生成特性
  - 确保所有数据在构建时获取
  - 避免客户端数据请求
  - 优化图片和资源加载

## 内容编写

- [ ] **任务 9.1**: 编写功能特性描述
  - 本地运行: 所有数据本地处理,保护隐私
  - 隐私保护: 代码不上传,完全离线
  - 快速响应: 毫秒级响应,无需等待
  - 跨平台支持: Windows、macOS、Linux
  - 自动更新: 支持自动检查和下载更新
  - 多语言支持: 支持中英文界面

- [ ] **任务 9.2**: 编写系统要求
  - Windows: Windows 10/11 (64-bit), 4GB RAM, 2GB 磁盘空间
  - macOS: macOS 12+ (Apple Silicon 或 Intel), 4GB RAM, 2GB 磁盘空间
  - Linux: Ubuntu 20.04+ / Debian 11+, 4GB RAM, 2GB 磁盘空间

- [ ] **任务 9.3**: 编写安装指南
  - Windows: 下载 .exe 安装包,运行安装程序,完成安装
  - macOS: 下载 .dmg 文件,拖拽到 Applications 文件夹
  - Linux: 下载 .AppImage 或 .deb 包,添加执行权限或使用 dpkg 安装

- [ ] **任务 9.4**: 编写 FAQ 内容
  - Q: Desktop 和在线版本有什么区别?
  - Q: 如何检查更新?
  - Q: 支持哪些 AI 模型?
  - Q: 数据存储在哪里?
  - Q: 如何卸载?

## 验证测试

- [ ] **任务 10.1**: TypeScript 类型检查
  ```bash
  npm run typecheck
  ```
  - 确保无 TypeScript 错误

- [ ] **任务 10.2**: 本地构建验证
  ```bash
  npm run build
  ```
  - 确保构建成功无错误
  - 检查构建输出确认页面被正确生成

- [ ] **任务 10.3**: 开发服务器预览
  ```bash
  npm run dev
  ```
  - 在浏览器中访问 `/desktop` 页面
  - 测试所有功能是否正常
  - 测试响应式布局

- [ ] **任务 10.4**: 内容完整性检查
  - 确认所有章节已编写
  - 确认所有组件正常显示
  - 确认所有链接有效
  - 检查 frontmatter 完整且格式正确

- [ ] **任务 10.5**: 下载功能测试
  - 测试各平台下载按钮
  - 确认下载链接正确
  - 验证文件名和版本号

- [ ] **任务 10.6**: 导航集成测试
  - 测试导航栏链接是否正确显示
  - 点击链接确认正确导航到 Desktop 页面
  - 测试移动端菜单

- [ ] **任务 10.7**: 主题切换测试
  - 测试浅色主题下的样式
  - 测试深色主题下的样式
  - 确认主题切换时无样式闪烁

- [ ] **任务 10.8**: 错误处理测试
  - 模拟 `index.json` 获取失败
  - 确认显示友好的错误信息
  - 测试超时处理

## 文档完善

- [ ] **任务 11.1**: 添加 SEO 元数据
  - 设置页面标题: "Hagicode Desktop - 下载"
  - 设置页面描述: 包含关键词
  - 添加 Open Graph 标签

- [ ] **任务 11.2**: 添加 Analytics
  - 确保页面集成 Microsoft Clarity (如果已配置)
  - 添加下载事件跟踪 (可选)

## 发布准备

- [ ] **任务 12.1**: 最终审查
  - 完整阅读页面,检查流畅性和连贯性
  - 确认页面符合 `proposal.md` 中的所有目标和验证标准
  - 检查与现有文档站点的一致性

- [ ] **任务 12.2**: 提交前检查
  - 运行 `npm run typecheck` 确保无类型错误
  - 运行 `npm run build` 确保构建成功
  - 检查文件命名符合 kebab-case 规范
  - 确认文件位于正确路径

## 可选增强 (如时间允许)

- [ ] **任务 13.1**: 添加产品截图
  - 添加 Desktop 应用界面截图
  - 展示不同平台的外观
  - 使用图片轮播或网格展示

- [ ] **任务 13.2**: 添加用户评价
  - 展示用户对 Desktop 的评价
  - 使用卡片或引用样式
  - 包含用户头像和姓名

- [ ] **任务 13.3**: 添加版本对比
  - 对比不同版本的差异
  - 使用表格或时间线展示
  - 突出最新版本的新功能

- [ ] **任务 13.4**: 添加下载统计
  - 显示各平台下载次数 (如果有数据源)
  - 使用图表或统计卡片展示

## 任务依赖关系

```
前置准备 (任务 0.1-0.2, 0.4)
    ↓
数据结构设计 (任务 0.3a, 1.1-1.3)  # 新增 0.3a 数据检查和 1.2 平台推断
    ↓
页面结构 (任务 2.1-2.2)
    ↓
组件开发 (任务 3.1-3.4) → 并行执行  # 3.2 改为版本资源列表组件
    ↓
页面内容实现 (任务 4.1-4.6) → 并行执行  # 4.1 和 4.5 根据数据限制调整
    ↓
导航集成 (任务 5.1-5.2)
    ↓
样式适配 (任务 6.1-6.2) → 并行执行
    ↓
错误处理 (任务 7.1-7.3) → 并行执行  # 7.3 新增平台推断验证
    ↓
性能优化 (任务 8.1-8.2) → 并行执行
    ↓
内容编写 (任务 9.1-9.4) → 并行执行
    ↓
验证测试 (任务 10.1-10.8)
    ↓
文档完善 (任务 11.1-11.2)
    ↓
发布准备 (任务 12.1-12.2)
    ↓
可选增强 (任务 13.1-13.4) → 可选并行
```

## 总计任务数

- **必需任务**: 59 个 (任务 0.1-12.2, 新增 0.3a 和 1.2)
- **可选任务**: 4 个 (任务 13.1-13.4)

## 预计完成时间

- **数据结构和工具**: 1-2 小时
- **组件开发**: 2-3 小时
- **页面内容实现**: 2-3 小时
- **样式和适配**: 1-2 小时
- **测试和验证**: 1-2 小时
- **总计**: 7-12 小时

## 注意事项

1. **遵循 OpenSpec 工作流**: 在提案获得批准前不要开始实施
2. **保持内容聚焦**: Desktop 页面应聚焦产品展示和下载,避免过度详细的功能文档
3. **数据获取时机**: 确保所有数据在构建时获取,不使用客户端请求
4. **错误处理优先**: 优先实现健壮的错误处理,确保页面在异常情况下仍可用
5. **样式一致性**: 与现有文档站点保持视觉一致性,使用相同的 CSS 变量和设计模式
6. **性能考虑**: 优化页面加载性能,确保快速响应用户操作
7. **可访问性**: 确保页面符合 WCAG AA 标准,支持键盘导航和屏幕阅读器
