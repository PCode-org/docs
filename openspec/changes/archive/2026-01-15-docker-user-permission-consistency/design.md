# Docker 容器用户权限一致性解决方案设计文档

## Context

### 背景

Docker 容器化部署是 Hagicode 的推荐安装方式。在实际使用中，容器内外用户权限映射问题是一个常见的痛点，特别影响：

- 宿主机使用 root 用户创建工作目录的用户
- 需要在容器内读写挂载目录文件的用户
- 多用户共享开发环境的场景

### 约束条件

- Hagicode Docker 镜像内的应用用户是非 root 用户
- 不同的 Docker 镜像可能使用不同的用户 ID（通过 Hash Code 生成）
- 宿主机环境多样化（Linux、macOS、Windows，权限模型不同）
- 文档必须保持与现有 Docker Compose 部署文档的一致性

### 利益相关者

- **最终用户**：需要快速部署和使用 Hagicode，不希望被权限问题阻塞
- **文档维护者**：需要清晰、可维护的文档内容
- **开发团队**：需要减少因权限问题导致的支持成本

## Goals / Non-Goals

### Goals

1. **提供清晰的权限问题说明**
   - 解释容器内外用户 ID 映射的原理
   - 说明权限冲突的根本原因
   - 帮助用户理解为什么会出现权限问题

2. **提供可操作的解决方案**
   - 方案一：用户 ID 映射配置（推荐，安全）
   - 方案二：权限设置（快速，适用于开发环境）
   - 每种方案都有详细的操作步骤

3. **完善故障排除指南**
   - 常见权限错误信息及解决方法
   - 诊断权限问题的命令
   - 预防权限问题的最佳实践

### Non-Goals

- 不修改 Docker 镜像本身（由上游镜像决定用户 ID）
- 不实现自动用户 ID 检测工具
- 不覆盖所有可能的权限场景（聚焦常见问题）
- 不深入 Linux 文件权限系统的理论讲解

## Decisions

### 决策一：提供两种解决方案而非强制一种

**决策内容**：同时提供用户 ID 映射和权限设置两种方案，并明确标注推荐方案。

**原因**：
- 不同用户有不同的安全需求和操作习惯
- 开发环境可能更关注便利性，生产环境更关注安全性
- 给用户选择权，提高文档的适用性

**备选方案考虑**：
- **仅提供用户 ID 映射方案**：更安全，但某些用户可能觉得配置复杂
- **仅提供权限设置方案**：更简单，但不够安全，不推荐用于生产环境

### 决策二：推荐使用 PUID/PGID 环境变量

**决策内容**：在 docker-compose.yml 示例中添加 `PUID` 和 `PGID` 环境变量配置说明。

**原因**：
- 这是 Docker 生态中常见的用户权限管理模式
- 许多 Docker 镜像（如 LinuxServer.io 镜像）都支持这种模式
- 配置简单，用户友好

**备选方案考虑**：
- **使用 `--user` 参数**：需要在 docker run 命令中指定，Docker Compose 中不够直观
- **修改镜像内的用户 ID**：需要自定义镜像，增加部署复杂度

### 决策三：独立章节而非分散在各处

**决策内容**：在 Docker Compose 文档中创建独立的"用户权限管理"章节。

**原因**：
- 权限问题是一个完整的话题，集中说明更易于理解
- 便于用户在遇到问题时快速定位到相关章节
- 保持文档结构的清晰性

**备选方案考虑**：
- **分散在各个配置说明中**：会导致权限说明分散，不易查阅
- **单独的权限文档**：对于 Docker Compose 部署来说过于冗余

## Technical Design

### 文档结构设计

在 `docs/installation/docker-compose.md` 中添加以下章节结构：

```markdown
## 用户权限管理

### 为什么需要关注用户权限

[权限问题说明]

### 方案一：用户 ID 映射配置（推荐）

[方案一详细说明]

### 方案二：权限设置

[方案二详细说明]

### 故障排除

[常见权限问题及解决方法]
```

### 方案一：用户 ID 映射配置

**配置步骤**：

1. **在宿主机创建非 root 用户**（如果使用 root 用户操作）
2. **获取用户 ID 和组 ID**
   ```bash
   id username
   ```
3. **配置 docker-compose.yml**
   ```yaml
   services:
     hagicode:
       environment:
         - PUID=1000
         - PGID=1000
   ```
4. **重启容器**
   ```bash
   docker compose restart hagicode
   ```

**适用场景**：
- 宿主机使用 root 用户操作
- 需要安全的权限配置
- 生产环境部署

**优点**：
- 安全性高，符合最小权限原则
- 文件权限清晰，易于管理
- 适用于多用户环境

**缺点**：
- 需要额外配置步骤
- 需要了解用户 ID 和组 ID

### 方案二：权限设置

**操作步骤**：

1. **使用 root 创建工作目录**
   ```bash
   sudo mkdir -p /path/to/repos
   ```
2. **设置目录权限为 777**
   ```bash
   sudo chmod 777 /path/to/repos
   ```
3. **验证权限**
   ```bash
   ls -la /path/to/repos
   ```

**适用场景**：
- 开发环境
- 单用户环境
- 需要快速解决权限问题

**优点**：
- 操作简单，快速解决
- 无需修改 Docker 配置

**缺点**：
- 安全性较低，任何用户都可以读写
- 不适合生产环境
- 多用户环境可能存在风险

### 故障排除设计

**常见问题及解决方案**：

| 问题现象 | 可能原因 | 解决方案 |
|---------|---------|---------|
| 容器内无法写文件 | 用户 ID 不匹配 | 配置 PUID/PGID 或设置目录权限 |
| 容器内创建的文件宿主机无法访问 | 所有者 ID 不一致 | 使用方案一配置用户 ID 映射 |
| Permission denied 错误 | 文件或目录权限不足 | 检查并修改文件/目录权限 |

**诊断命令**：
```bash
# 检查宿主机文件权限
ls -la /path/to/repos

# 检查容器内用户
docker exec hagicode-app id

# 检查容器内文件权限
docker exec hagicode-app ls -la /app/workdir
```

## Risks / Trade-offs

### 风险

1. **文档复杂度增加**
   - 风险：添加权限管理章节会增加文档长度
   - 缓解措施：使用清晰的章节结构和折叠内容，保持可读性

2. **用户可能选择不安全的方案**
   - 风险：用户可能为了方便选择方案二（777 权限）
   - 缓解措施：明确标注方案一为推荐方案，说明方案二的安全风险

3. **不同操作系统权限模型差异**
   - 风险：Windows 和 Linux/macOS 的权限模型不同
   - 缓解措施：文档中主要针对 Linux 系统，Windows 用户使用 WSL2 时适用相同方案

### 权衡

1. **安全性 vs 便利性**
   - 提供两种方案，让用户根据场景选择
   - 生产环境推荐使用安全的用户 ID 映射方案
   - 开发环境可以使用快速但不够安全的权限设置方案

2. **完整性 vs 简洁性**
   - 保持文档完整性，涵盖常见权限问题
   - 使用清晰的章节结构避免信息过载
   - 提供故障排除快速参考表

## Migration Plan

### 实施步骤

1. 在 `docs/installation/docker-compose.md` 的"配置说明"章节后添加"用户权限管理"章节
2. 编写权限问题说明、两种解决方案和故障排除内容
3. 在 docker-compose.yml 示例中添加 PUID/PGID 注释说明
4. 更新文档中的相关链接（如有）

### 验证方法

1. 本地构建验证：`npm run build`
2. 类型检查：`npm run typecheck`
3. 本地预览：`npm start`
4. 检查文档渲染效果和链接正确性

### 回滚计划

如果新内容存在问题，可以直接删除"用户权限管理"章节，不影响文档的其他部分。

## Open Questions

1. **是否需要添加用户 ID 自动检测脚本？**
   - 当前决策：不需要，保持文档简单
   - 未来可以考虑：如果用户反馈强烈

2. **是否需要支持 Windows 容器？**
   - 当前决策：仅针对 Linux 容器，这是 Hagicode 使用的容器类型
   - Windows 用户可以使用 WSL2 获得相同的体验

3. **是否需要在其他部署方式文档中也添加权限说明？**
   - 当前决策：不需要，权限问题主要在容器化部署中出现
   - 软件包部署方式通常使用当前用户运行，不存在权限映射问题
